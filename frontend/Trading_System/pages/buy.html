<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Buy Stocks | Stock Trading Simulator</title>
    <meta
      name="description"
      content="Place simulated buy orders with live-style UI and confirmations."
    />
    <meta name="robots" content="index,follow" />
    <meta name="theme-color" content="#0a2540" />
    <meta name="color-scheme" content="light dark" />
    <link rel="icon" href="../images/favicon.svg" type="image/svg+xml" />
    <link rel="apple-touch-icon" href="../images/apple-touch-icon.png" />
    <link rel="canonical" href="/pages/buy.html" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Buy • Stock Trading Simulator" />
    <meta
      property="og:description"
      content="Simulate buy orders in a clean, professional interface."
    />
    <meta property="og:image" content="../images/social-card.png" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Buy • Stock Trading Simulator" />
    <meta
      name="twitter:description"
      content="Simulate buy orders in a clean, professional interface."
    />
    <meta name="twitter:image" content="../images/social-card.png" />
    <link rel="stylesheet" href="../css/styles.css" />
  </head>
  <body>
    <div class="app">
      <header class="site-header" role="banner">
        <div class="branding">
          <h1>Stock Trading Simulator</h1>
        </div>
      </header>

      <nav class="site-nav" role="navigation" aria-label="Primary">
        <div class="nav-container">
          <label
            for="nav-toggle"
            class="nav-toggle-label"
            aria-label="Toggle navigation"
          >
            <span class="bar"></span>
          </label>
          <input type="checkbox" id="nav-toggle" class="nav-toggle" />
          <ul class="menu">
            <li><a href="../index.html">Home</a></li>
            <li><a href="./portfolio.html">Portfolio</a></li>
            <li><a href="./buy.html" aria-current="page">Buy Stocks</a></li>
            <li><a href="./sell.html">Sell Stocks</a></li>
            <li><a href="./transactions.html">Transactions</a></li>
            <li><a href="./deposit.html">Deposit</a></li>
            <li><a href="./withdraw.html">Withdraw</a></li>
            <li><a href="./login.html">Logout</a></li>
            <li class="admin-only">
              <a href="./admin-create-stock.html">Create New Stock</a>
            </li>
            <li class="admin-only">
              <a href="./admin-market-hours.html">Change Market Hours</a>
            </li>
            <li class="admin-only">
              <a href="./admin-market-schedule.html">Change Market Schedule</a>
            </li>
          </ul>
        </div>
      </nav>

      <main class="site-main">
        <div class="container">
          <section class="card" aria-labelledby="buy-title">
            <h2 class="page-title" id="buy-title">Buy Stock</h2>
            <div class="grid two">
              <div>
                <div class="section-title">Your Capital</div>
                <div class="stat">
                  <span class="label">Balance</span>
                  $<span class="value" id="cash-amount">—</span>
                </div>
              </div>
              <div>
                <div class="section-title">Stock Order</div>
                <p class="subtle">
                  Enter the order details below. A confirmation will appear
                  before placing the order.
                </p>
              </div>
            </div>

            <div class="msg success" role="status" aria-live="polite">
              Order placed successfully.
            </div>
            <div class="msg error" role="alert" aria-live="polite">
              Insufficient funds.
            </div>

            <form class="form" action="#" method="post" novalidate>
              <div class="form-row">
			    <label for="tickerSelect">Choose a Stock</label>
			    <select id="tickerSelect" class="form-select">
                  <option value="">Loading...</option>
			    </select>
			    <div style="font-size: 12px; color: #666; margin: 4px 0 10px;">
			      (Selecting a stock will auto-fill the Ticker box below. You can also type a ticker manually.)
                </div>
              </div>
			  <div class="form-row">
                <label for="buyTicker">Stock Ticker</label>
                <input
                  type="text"
                  id="buyTicker"
                  name="ticker"
                  placeholder="e.g., AAPL"
                  required
                />
              </div>
              <div class="form-row">
                <label for="buyQty">Quantity</label>
                <input
                  type="number"
                  id="buyQty"
                  name="quantity"
                  min="1"
                  step="1"
                  required
                />
              </div>
              <div class="grid two">
                <div>
                  <div class="section-title">Current Price</div>
                  <div class="stat">
                    <span class="label">Price</span>
                    $<span class="value" id="price-value">—</span>
                  </div>
                </div>
                <div>
                  <div class="section-title">Total Cost</div>
                  <div class="stat">
                    <span class="label">Total</span>
                    $<span class="value" id="total-value">—</span>
                  </div>
                </div>
              </div>
              <div class="section-title">Chart</div>
              <div class="chart" aria-label="Stock chart placeholder">
                Stock chart will render here
              </div>
              <div class="actions">
                <button type="submit" class="btn btn-primary">Buy</button>
                <a class="btn btn-cancel" href="../index.html">Cancel</a>
              </div>
            </form>
          </section>
        </div>
      </main>

      <footer class="site-footer" role="contentinfo">
        <div class="footer-inner">
          <div class="footer-top">
            <div class="footer-brand">
              <h3>Stock Trading Simulator</h3>
              <p>Practice orders in a safe, learning-first environment.</p>
            </div>
            <div class="footer-links">
              <h4>Explore</h4>
              <ul>
                <li><a href="./portfolio.html">Portfolio</a></li>
                <li><a href="./transactions.html">Transactions</a></li>
              </ul>
            </div>
            <div class="footer-links">
              <h4>Support</h4>
              <ul>
                <li><a href="mailto:support@example.com">Contact Us</a></li>
                <li><a href="./login.html">Login</a></li>
              </ul>
            </div>
          </div>
          <div class="footer-bottom">
            <span>© 2025 Stock Trading Simulator</span>
            <div class="social">
              <a href="#" aria-label="Twitter">T</a>
              <a href="#" aria-label="LinkedIn">in</a>
              <a href="#" aria-label="GitHub">GH</a>
            </div>
          </div>
        </div>
      </footer>
    </div>
	<script>
		// Replace this with your actual API Gateway Invoke URL
		window.API_BASE_URL = "https://6hhdszthdg.execute-api.us-east-1.amazonaws.com/prod";
	</script>
	
	<script type="module">
		import { requireAuth, placeOrder, renderCash } from "../javascript/api.js";
		
		//protects the page and shows current cash available
		requireAuth();
		renderCash();
		
		//Grabs DOM
		const form = document.querySelector("form");
		const tickerInput = document.getElementById("buyTicker");
		const qtyInput = document.getElementById("buyQty");
		const select = document.getElementById("tickerSelect");
		
		//uses messages boxes other wise falls back to alert
		const msgSuccess = document.querySelector(".msg.success");
		const msgError = document.querySelector(".msg.error");
		if (msgSuccess) msgSuccess.style.display = "none";
		if (msgError) msgError.style.display = "none";
		
		const fmt = (n) => Number(n).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2 });
		
		// --- Current Price & Total Cost User Interface targets ---
		const priceEl = document.getElementById("price-value");
		const totalEl = document.getElementById("total-value");
		let currentPrice = null;
		window.pricesByTicker = window.pricesByTicker || {};
		const pricesByTicker = window.pricesByTicker; // <- cache
		
		//This fethces the price for a ticker and render it
		async function loadPrice(t) {
		    const ticker = (t || "").toUpperCase().trim();
			if (!ticker) {
			    currentPrice = null;
				priceEl.textContent = "-";
				totalEl.textContent = "-";
				return
			}
			
			const cached = (window.pricesByTicker || {})[ticker];
			if (Number.isFinite(cached)) {
			  currentPrice = cached;
			  priceEl.textContent = `${fmt(currentPrice)}`;
			  const q = Number(qtyInput.value || 0);
			  totalEl.textContent = q > 0 && Number.isFinite(currentPrice) ? `${fmt(q * currentPrice)}` : "-";
			  return;
			}
			
			try {
				const r = await fetch (`${window.API_BASE_URL}/market/tickers/${encodeURIComponent(ticker)}`, {
					headers: {
						"Authorization": `Bearer ${localStorage.getItem("access_token") || ""}`
					}
				});
				if (!r.ok) throw new Error(`HTTP ${r.status}`);
				const data = await r.json();
				currentPrice = Number(data.current_price);
				priceEl.textContent = `${fmt(currentPrice)}`;
			
				// refreshes the total if the quantity is already typed
				const q = Number(qtyInput.value || 0);
				totalEl.textContent = q > 0 && Number.isFinite(currentPrice) ? `${fmt(q * currentPrice)}` : "-"	;
			}
			catch (e) {
				console.error("Failed to load price:", e);
				currentPrice = null;
				priceEl.textContent = "-";
				totalEl.textContent = "-";
			}
	    }
		
		// This is for when the user picks from the dropdown, should sync the input and load the Price
		
		select.addEventListener("change", () => {
		    const v = (select.value || "").toUpperCase();
			tickerInput.value = v;
			loadPrice(v);
		});
		
		// Also this will load the price for when the user finishes typing in the ticker too
		tickerInput.addEventListener("blur", () => loadPrice(tickerInput.value));
		
		form.addEventListener("submit", async (e) => {
			e.preventDefault();
			
			//Reads and validates
			const rawTicker = (tickerInput?.value || "").trim().toUpperCase();
			const rawQty = (qtyInput?.value || "").trim();
			const qty = Number(rawQty);
	
			if (!rawTicker) {
				showError("Enter a ticker symbol (e.g. ACME).");
				return;
			}
			
			//Disables submit to prevent double orders
			const submitButton = form.querySelector('button[type="submit"], input[type="submit"]');
			if (submitButton) submitButton.disabled = true;
			
			try {
				// POST /trades/order {ticker, side: "buy", quantity}
				const res = await placeOrder({ ticker: rawTicker, side: "buy", quantity: qty });
				
				//clears, shows confirmation, and refreshes cash available
				if (qtyInput) qtyInput.value = "";
				showSuccess(`BUY ${res.ticker} @ $${fmt(res.price)} * ${res.quantity} = $${fmt(res.total_value)}`);
				await renderCash();
			}
			
			catch (err) {
				showError(err.message || "Buy order failed.");
			}
			
			finally {
				if (submitButton) submitButton.disabled = false;
			}
		});

		function showSuccess(msg) {
			if (msgSuccess) {
				msgSuccess.textContent = msg;
				msgSuccess.style.display = "block";
			} 
			else {
				alert(msg);
			}
			if (msgError) msgError.style.display = "none";
		}

		function showError(msg) {
			if (msgError) {
				msgError.textContent = msg;
				msgError.style.display = "block";
			} 
			else {
				alert(msg);
			}
			if (msgSuccess) msgSuccess.style.display = "none";
		}
	</script>
	<script type="module">
      import { listTickers, requireAuth } from "../javascript/api.js";
      //requireAuth(); already called in first module
  
      const select = document.getElementById("tickerSelect");
      const tickerInput =
        document.getElementById("buyTicker") ||
        document.querySelector('[name="ticker"]');
	  const qtyInput = document.getElementById("buyQty");
	  const priceEl = document.getElementById("price-value");
	  const totalEl = document.getElementById("total-value");
	  const pricesByTicker = (window.pricesByTicker = window.pricesByTicker || {});
	  const fmt = (n) => Number(n).toLocalString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2 });

      function makeOpt(label, value = "") {
        const o = document.createElement("option");
        o.value = value;
        o.textContent = label;
        return o;
      }

      (async () => {
        try {
          const stocks = await listTickers();
		  select.innerHTML = "";
          select.appendChild(makeOpt("Select a Stock", ""));
          stocks.forEach(s => {
            select.appendChild(makeOpt(`${s.ticker} — ${s.company_name}`, s.ticker));
			pricesByTicker[s.ticker] = Number(s.current_price);
          });
        } 
		catch (e) {
          select.innerHTML = "";
          select.appendChild(makeOpt("Failed to load stocks", ""));
          select.disabled = true;
          console.error(e);
        }
      })();
	  
	  function renderTotals() {
	      const q = Number(qtyInput.value || 0);
		  const t = (tickerInput.value || "").toUpperCase().trim();
		  const p = pricesByTicker[t];
		  if (Number.isFinite(p)) {
		      priceEl.textContent = `${fmt(p)}`
			  totalEl.textContent = q > 0 ? `${fmt(q * p)}` : "-";
	      }
      else {
	      priceEl.textContent = "-";
		  totalEl.textContent = "-";
	  }
	  
	  // Events to keep user interface in sync
	  select.addEventListener("change", () => {
      tickerInput.value = (select.value || "").toUpperCase();
      renderTotals();
      });
	  tickerInput.addEventListener("blur", renderTotals);
      qtyInput.addEventListener("input", renderTotals);

      // Initial render
      renderTotals();

      // Sync dropdown → text input
      if (select && tickerInput) {
        select.addEventListener("change", () => {
          tickerInput.value = select.value || "";
          if (tickerInput.value) tickerInput.value = tickerInput.value.toUpperCase();
        });
        
        // Sync text input → dropdown
        tickerInput.addEventListener("input", () => {
          const v = (tickerInput.value || "").toUpperCase();
          const match = [...select.options].find(o => o.value === v);
          select.value = match ? v : "";
        });
      }
    </script>
  </body>
</html>
